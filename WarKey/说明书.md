# 魔兽争霸改键软件设计说明书

## 1. 项目概述

### 1.1 项目目标
开发一款支持魔兽争霸III的改键软件，通过AI自动生成代码，实现物品栏和技能按键的自定义映射，提升玩家操作效率和游戏体验。

### 1.2 核心功能
- 物品栏6个格子的按键自定义
- 英雄技能按键自定义
- 单位技能按键自定义
- 支持组合键设置
- 热键切换不同改键配置
- 配置文件导入/导出

## 2. 系统架构

### 2.1 总体架构
```
┌─────────────────────────────────────────┐
│         用户界面层 (UI Layer)          │
├─────────────────────────────────────────┤
│       业务逻辑层 (Logic Layer)         │
├─────────────────────────────────────────┤
│      热键管理模块   配置管理模块       │
├─────────────────────────────────────────┤
│    钩子拦截层 (Hook/Interception)      │
└─────────────────────────────────────────┘
```

### 2.2 技术选型
- **开发语言**: C++ / C# / Python (基于AI生成代码需求)
- **热键拦截**: Windows API Hook / 键盘过滤驱动
- **配置文件**: JSON / XML
- **UI框架**: Qt / WinForms / Tkinter

## 3. 详细设计

### 3.1 按键映射模块

#### 3.1.1 数据结构
```cpp
// 按键映射结构
struct KeyMapping {
    string originalKey;      // 原始按键
    string mappedKey;        // 映射后的按键
    KeyType type;           // 按键类型：物品/技能
    int position;           // 位置索引(物品格0-5, 技能0-5)
    bool isEnabled;         // 是否启用
};

// 配置结构
struct KeyConfig {
    string configName;
    vector<KeyMapping> itemMappings[6];    // 物品栏映射
    vector<KeyMapping> skillMappings[6];   // 技能映射
    vector<KeyMapping> unitMappings[10];   // 单位技能映射
    bool useModifierKey;                   // 是否使用修饰键
    string modifierKey;                    // 修饰键(Ctrl/Alt/Shift)
};
```

#### 3.1.2 映射规则
- 物品栏: 默认1-6，可映射到任意按键
- 英雄技能: Q, W, E, R, T, Y (可自定义)
- 单位技能: A, S, D, F, G, H, Z, X, C, V (可自定义)
- 支持组合键: Ctrl+Q, Alt+1 等

### 3.2 热键拦截模块

#### 3.2.1 拦截机制
```cpp
// Windows钩子实现示例
class KeyboardHook {
private:
    HHOOK keyboardHook;
    
public:
    bool InstallHook();
    bool UninstallHook();
    
    // 钩子回调函数
    static LRESULT CALLBACK KeyboardProc(int nCode, WPARAM wParam, LPARAM lParam);
    
    // 按键处理逻辑
    KeyEvent ProcessKeyEvent(const KeyEvent& event);
};
```

#### 3.2.2 事件处理流程
```
按键按下 → 钩子捕获 → 检查映射表 → 
├→ 找到映射: 发送映射按键 + 阻止原始按键
└→ 未找到: 放行原始按键
```

### 3.3 配置管理模块

#### 3.3.1 配置文件格式(JSON示例)
```json
{
  "config_name": "Human_Standard",
  "version": "1.0",
  "item_mappings": [
    {"original": "1", "mapped": "F1", "enabled": true},
    {"original": "2", "mapped": "F2", "enabled": true}
  ],
  "skill_mappings": [
    {"original": "Q", "mapped": "1", "enabled": true},
    {"original": "W", "mapped": "2", "enabled": true}
  ],
  "settings": {
    "auto_start": false,
    "show_notifications": true,
    "game_process": "war3.exe"
  }
}
```

#### 3.3.2 配置操作
- 新建/保存/删除配置文件
- 导入/导出配置文件
- 配置文件版本管理

### 3.4 用户界面设计

#### 3.4.1 主界面布局
```
┌─────────────────────────────────────┐
│ 魔兽争霸改键助手 v1.0              │
├─────────────────────────────────────┤
│ [配置选择] Default ▾  [新建] [导入]│
├──────┬──────────────────────────────┤
│      │ 物品栏按键设置              │
│      ├──────────────────────────────┤
│      │ [1] → [F1]  ▾  [启用]      │
│      │ [2] → [F2]  ▾  [启用]      │
│      │ ...                         │
│      ├──────────────────────────────┤
│ 导   │ 英雄技能设置                │
│ 航   ├──────────────────────────────┤
│ 栏   │ [Q] → [1]   ▾  [启用]      │
│      │ [W] → [2]   ▾  [启用]      │
│      │ ...                         │
│      ├──────────────────────────────┤
│      │ [保存配置] [应用] [重置]   │
└──────┴──────────────────────────────┘
```

#### 3.4.2 功能区域
1. **配置管理区**: 配置文件操作
2. **物品栏设置区**: 6个物品格按键设置
3. **技能设置区**: 英雄/单位技能按键设置
4. **状态显示区**: 当前状态、热键提示

## 4. AI生成代码提示

### 4.1 关键函数模板
```python
# AI代码生成提示
"""
请生成以下功能的代码：
1. 键盘钩子安装和卸载函数
2. 按键映射查找函数
3. 模拟键盘按键发送函数
4. 配置文件读写函数
5. 用户界面更新函数

要求：
- 使用面向对象设计
- 包含错误处理
- 支持线程安全
- 添加详细注释
"""
```

### 4.2 核心算法
```cpp
// 按键映射算法
class KeyRemapper {
public:
    // 主映射函数
    KeyEvent remapKey(const KeyEvent& input) {
        // 1. 检查当前激活窗口是否为魔兽争霸
        if (!isTargetWindowActive()) return input;
        
        // 2. 查找映射
        KeyMapping* mapping = findMapping(input.keyCode, input.modifiers);
        
        // 3. 应用映射
        if (mapping && mapping->isEnabled) {
            return createMappedEvent(input, mapping);
        }
        
        return input;
    }
};
```

## 5. 技术实现细节

### 5.1 热键拦截实现方案

#### 方案A: Windows钩子(推荐)
```cpp
// 低级键盘钩子
HHOOK SetWindowsHookEx(
    WH_KEYBOARD_LL,      // 钩子类型
    KeyboardProc,        // 回调函数
    hInstance,           // 实例句柄
    0                    // 线程ID
);
```

#### 方案B: 输入拦截库
- 使用`Interception`库(开源)
- 使用`Windows Input Simulator`

### 5.2 按键模拟实现
```cpp
// 发送键盘事件
void SendKeyEvent(const string& key, bool isPress) {
    INPUT input = {0};
    input.type = INPUT_KEYBOARD;
    input.ki.wVk = GetVirtualKeyCode(key);
    input.ki.dwFlags = isPress ? 0 : KEYEVENTF_KEYUP;
    SendInput(1, &input, sizeof(INPUT));
}
```

### 5.3 进程检测
```cpp
// 检测魔兽争霸进程
bool IsWar3Running() {
    // 通过进程名或窗口标题检测
    // 支持多个版本：war3.exe, Warcraft III.exe
}
```

## 6. 错误处理与日志

### 6.1 错误类型
1. 钩子安装失败
2. 配置文件损坏
3. 按键冲突
4. 权限不足

### 6.2 日志系统
```cpp
class Logger {
public:
    enum LogLevel { DEBUG, INFO, WARNING, ERROR };
    
    void log(LogLevel level, const string& message);
    void saveToFile(const string& filename);
};
```

## 7. 部署与使用

### 7.1 系统要求
- Windows 7/8/10/11
- 管理员权限(第一次运行)

### 7.2 安装包内容
```
/WarcraftKeyRemapper/
├── KeyRemapper.exe      # 主程序
├── configs/            # 配置文件夹
│   ├── default.json
│   └── pro_player.json
├── logs/               # 日志文件夹
├── manual.pdf          # 用户手册
└── uninstall.exe       # 卸载程序
```

### 7.3 使用流程
1. 运行程序(需要管理员权限)
2. 选择或创建配置
3. 设置物品栏和技能按键
4. 点击"应用"按钮
5. 启动魔兽争霸游戏

## 8. 测试计划

### 8.1 功能测试
- [ ] 基本按键映射功能
- [ ] 组合键支持
- [ ] 配置文件操作
- [ ] 热键切换
- [ ] 进程检测

### 8.2 兼容性测试
- [ ] 魔兽争霸1.24-1.32版本
- [ ] 不同Windows版本
- [ ] 不同输入法
- [ ] 与其他软件的兼容性

### 8.3 性能测试
- [ ] 按键响应延迟(<10ms)
- [ ] 内存占用(<50MB)
- [ ] CPU占用率(<2%)

## 9. 安全考虑

### 9.1 反作弊兼容性
- 不修改游戏内存
- 不使用注入技术
- 仅使用官方支持的API
- 提供白名单模式

### 9.2 用户隐私
- 不收集用户数据
- 配置文件本地存储
- 无网络连接要求

## 10. 未来扩展

### 10.1 计划功能
- 宏功能支持
- 配置文件云同步
- 按键序列录制
- 游戏内叠加显示
- 多语言支持

### 10.2 跨平台支持
- macOS版本(如支持)
- Linux版本(如支持)

---

## 附录

### A. 默认按键映射参考
| 功能 | 默认按键 | 常用改键 |
|------|---------|----------|
| 物品栏1 | 1 | F1, ~, Mouse4 |
| 物品栏2 | 2 | F2, Mouse5 |
| 英雄技能Q | Q | 1, A |
| 英雄技能W | W | 2, S |

### B. 魔兽争霸进程信息
- 进程名: `war3.exe`
- 窗口类: `Warcraft III`
- 支持版本: 1.24e - 1.32.10

### C. 开发时间估算
- 核心功能: 2-3周
- 用户界面: 1-2周
- 测试调试: 1-2周
- 文档完善: 1周

---
